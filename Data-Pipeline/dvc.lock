schema: '2.0'
stages:
  download_val_and_ann:
    cmd: python scripts/download_coco2017.py --out data/raw_zips --subset val
    deps:
    - path: scripts/download_coco2017.py
      hash: md5
      md5: 90172354df68bce635dec110ccc85ae6
      size: 2947
    outs:
    - path: data/raw_zips/annotations_trainval2017.zip
      hash: md5
      md5: f4bbac642086de4f52a3fdda2de5fa2c
      size: 252907541
    - path: data/raw_zips/val2017.zip
      hash: md5
      md5: 442b8da7639aecaf257c1dceb8ba8c80
      size: 815585330
  extract_val_and_ann:
    cmd: "python scripts/extract_zips.py --zips data/raw_zips --raw data/raw --subset
      val && python -c \"from pathlib import Path; Path('data/raw/.val_extracted.done').write_text('ok\\\
      \\n')\"\n"
    deps:
    - path: data/raw_zips/annotations_trainval2017.zip
      hash: md5
      md5: f4bbac642086de4f52a3fdda2de5fa2c
      size: 252907541
    - path: data/raw_zips/val2017.zip
      hash: md5
      md5: 442b8da7639aecaf257c1dceb8ba8c80
      size: 815585330
    - path: scripts/extract_zips.py
      hash: md5
      md5: a315f77a9b38c7aa52e06235e9ea8b09
      size: 1089
    outs:
    - path: data/raw/.val_extracted.done
      hash: md5
      md5: e02f288d5ef7b53b6112665d1bbc29d8
      size: 4
    - path: data/raw/annotations
      hash: md5
      md5: 1b4ce3d407ac70dc7f3a4c0933f77469.dir
      size: 834416290
      nfiles: 6
    - path: data/raw/val2017
      hash: md5
      md5: a0173f60761f977a5afe88aa2d75acb6.dir
      size: 814705164
      nfiles: 5000
  download_train:
    cmd: python scripts/download_coco2017.py --out data/raw_zips --subset train
    deps:
    - path: scripts/download_coco2017.py
      hash: md5
      md5: 90172354df68bce635dec110ccc85ae6
      size: 2947
    outs:
    - path: data/raw_zips/train2017.zip
      hash: md5
      md5: cced6f7f71b7629ddf16f17bbcfab6b2
      size: 19336861798
  extract_train:
    cmd: "python scripts/extract_zips.py --zips data/raw_zips --raw data/raw --subset
      train && python -c \"from pathlib import Path; Path('data/raw/.train_extracted.done').write_text('ok\\\
      \\n')\"\n"
    deps:
    - path: data/raw_zips/train2017.zip
      hash: md5
      md5: cced6f7f71b7629ddf16f17bbcfab6b2
      size: 19336861798
    - path: scripts/extract_zips.py
      hash: md5
      md5: a315f77a9b38c7aa52e06235e9ea8b09
      size: 1089
    outs:
    - path: data/raw/.train_extracted.done
      hash: md5
      md5: e02f288d5ef7b53b6112665d1bbc29d8
      size: 4
    - path: data/raw/train2017
      hash: md5
      md5: 107409cf0f5a123bade82b25cbfa38b8.dir
      size: 19314466396
      nfiles: 118287
  coco_to_yolo:
    cmd: "python scripts/convert_coco_to_yolo.py --raw data/raw --out data/processed
      && python scripts/fill_missing_labels.py --processed data/processed --raw data/raw\n"
    deps:
    - path: data/raw/.train_extracted.done
      hash: md5
      md5: e02f288d5ef7b53b6112665d1bbc29d8
      size: 4
    - path: data/raw/.val_extracted.done
      hash: md5
      md5: e02f288d5ef7b53b6112665d1bbc29d8
      size: 4
    - path: data/raw/annotations/instances_train2017.json
      hash: md5
      md5: 20542493efc7df5d9340522b7c87b06c
      size: 469785474
    - path: data/raw/annotations/instances_val2017.json
      hash: md5
      md5: b681580a54b900b3cb44022fd1102ad5
      size: 19987840
    - path: scripts/convert_coco_to_yolo.py
      hash: md5
      md5: 875e2dfe3f7c9e39a6c7d2ad7dfbe3a2
      size: 2604
    - path: scripts/fill_missing_labels.py
      hash: md5
      md5: be2997651c9ebf77c3c00375e6786b89
      size: 2405
    outs:
    - path: data/processed/coco.names
      hash: md5
      md5: a0a1f162783325f13da3f9840cf172f0
      size: 699
    - path: data/processed/labels
      hash: md5
      md5: 947674f4df70e10bae6a98e16fa6b692.dir
      size: 35070252
      nfiles: 123287
  preprocess_images_link:
    cmd: python scripts/preprocess_images.py --raw data/raw --processed 
      data/processed --mode link
    deps:
    - path: data/raw/.train_extracted.done
      hash: md5
      md5: e02f288d5ef7b53b6112665d1bbc29d8
      size: 4
    - path: data/raw/.val_extracted.done
      hash: md5
      md5: e02f288d5ef7b53b6112665d1bbc29d8
      size: 4
    - path: data/raw/train2017
      hash: md5
      md5: 107409cf0f5a123bade82b25cbfa38b8.dir
      size: 19314466396
      nfiles: 118287
    - path: data/raw/val2017
      hash: md5
      md5: a0173f60761f977a5afe88aa2d75acb6.dir
      size: 814705164
      nfiles: 5000
    - path: scripts/preprocess_images.py
      hash: md5
      md5: 16d9dbb3fa4197ccfeb3a12cea2051b3
      size: 1718
    outs:
    - path: data/processed/images
      hash: md5
      md5: 72d1c2489daeb8507d42936e43126c08.dir
      size: 20129171560
      nfiles: 123287
  splits:
    cmd: python scripts/create_splits.py --processed data/processed --out 
      data/splits --test-frac 0.10
    deps:
    - path: data/processed/images
      hash: md5
      md5: 72d1c2489daeb8507d42936e43126c08.dir
      size: 20129171560
      nfiles: 123287
    - path: data/processed/labels
      hash: md5
      md5: 947674f4df70e10bae6a98e16fa6b692.dir
      size: 35070252
      nfiles: 123287
    - path: scripts/create_splits.py
      hash: md5
      md5: 5dbc170d2e919ce526f7bc6247ca346f
      size: 1370
    outs:
    - path: data/splits
      hash: md5
      md5: b9c88eb00c4549fb4bbabd5da5823a6d.dir
      size: 6154350
      nfiles: 3
  reports:
    cmd: "python scripts/schema_stats.py --processed data/processed --splits data/splits
      --out data/reports && python scripts/quality_checks.py --processed data/processed
      --splits data/splits --out data/reports/quality.json && python scripts/anomaly_alerts.py
      --quality data/reports/quality.json && python scripts/bias_slicing.py --processed
      data/processed --splits data/splits --out data/reports/bias.md\n"
    deps:
    - path: data/processed
      hash: md5
      md5: f2c8e1010b6192d9f1f1c35679959153.dir
      size: 20164242511
      nfiles: 246575
    - path: data/splits
      hash: md5
      md5: b9c88eb00c4549fb4bbabd5da5823a6d.dir
      size: 6154350
      nfiles: 3
    - path: scripts/anomaly_alerts.py
      hash: md5
      md5: 42ce5dfb19ac899dea3aa231395573d1
      size: 1096
    - path: scripts/bias_slicing.py
      hash: md5
      md5: 6a8fcd83cd747a92c937c41dbd4f1bc7
      size: 2557
    - path: scripts/quality_checks.py
      hash: md5
      md5: f7c2cbf662bb211225c3bd79d8d770b9
      size: 4157
    - path: scripts/schema_stats.py
      hash: md5
      md5: a9d1fde8dd0de8d46c26d391e5e5e70d
      size: 1895
    outs:
    - path: data/reports
      hash: md5
      md5: b77ba5604e95c939e24e8e69c8787464.dir
      size: 3058
      nfiles: 4
